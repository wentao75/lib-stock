!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@wt/lib-wtda-query"),require("moment"),require("lodash"),require("debug")):"function"==typeof define&&define.amd?define(["exports","@wt/lib-wtda-query","moment","lodash","debug"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["@wt/lib-stock"]={},t.libWtdaQuery,t.moment,t._,t.debugpkg)}(this,(function(t,e,o,a,n){"use strict";function i(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=i(o),r=i(a),l=i(n);function c(t){return t.toLocaleString("zh-CN")}const u=l.default("trans");function d(t,e,o,a,n){if(r.default.isEmpty(o))return!1;if(!n.fixCash&&o.total+a.balance<0)return u(`账户余额${a.balance}不足(${o.total})，无法完成清算，交易取消! 交易信息: ${"buy"===o.type?"买入":"卖出"}${e.ts_code} ${o.count}股，价格${o.price}，共计${o.total}元[含佣金${o.commission}元，过户费${o.fee}，印花税${o.duty}元]`),!1;if(a.balance+=o.total,"buy"===o.type)a.stock={info:e,count:o.count,price:o.price,buy:o};else{let t={tradeDate:o.tradeDate,profit:a.stock.buy.total+o.total,income:o.count*o.price-a.stock.count*a.stock.price,buy:a.stock.buy,sell:o};a.stock={info:null,count:0,price:0},a.transactions.push(t)}return!0}function m(t,e,o,a){let n=o*a,i=.25*n/1e3,s=0,r=0;"SSE"===e.exchange?s+=.02*n/1e3:e.exchange,t||(r+=1*n/1e3);let l=0;return l=t?0-(n+i+s+r):n-i-s-r,{total:l,amount:n,commission:i,fee:s,duty:r}}function f(t){if(r.default.isEmpty(t))return;let e=t.transactions.length,o=0,a=0,n=0,i=0,s=0,l=0,c=0,u=0,d=0,m=0,f=0,p=0,$=0,y=0,x=0,_=0,b=0,h={},F=0,g=0,Y=0,w=0,k=0,T=0,v=0,D=0,M=0,S=0;for(let e of t.transactions){let t=e.sell.dateIndex-e.buy.dateIndex+1;h[e.sell.methodType]||(h[e.sell.methodType]={times:1,win_times:0,loss_times:0}),h[e.sell.methodType].times+=1,e.profit>=0?(o++,a+=e.profit,k+=-e.buy.total,c<e.profit&&(c=e.profit),M+=t,y<t&&(y=t),1===v?D++:(-1===v&&$<D&&($=D),v=1,D=1),h[e.sell.methodType].win_times+=1):(n++,i+=e.profit,T+=-e.buy.total,u>e.profit&&(u=e.profit),S+=t,x<t&&(x=t),-1===v?D++:(1===v&&p<D&&(p=D),v=-1,D=1),h[e.sell.methodType].loss_times+=1),s+=e.profit,l+=e.buy.commission+e.buy.fee+e.buy.duty+(e.sell.commission+e.sell.fee+e.sell.duty),w+=-e.buy.total}return 1===v?p<D&&(p=D):-1===v&&$<D&&($=D),d=s/e,m=a/o,f=-i/n,_=Number((M/o).toFixed(1)),b=Number((S/n).toFixed(1)),Y=s/w,F=a/k,g=i/T,{count:e,total_profit:s,total_fee:l,count_win:o,total_win:a,count_loss:n,total_loss:i,max_profit:c,max_loss:u,average_profit:d,average_win:m,average_loss:f,max_wintimes:p,max_losstimes:$,max_windays:y,max_lossdays:x,average_windays:_,average_lossdays:b,selltypes:h,ror:Y,ror_win:F,ror_loss:g}}function p(t){if(!t)return"";let e=t.buy,o=t.sell;return o?`收入：${c(t.profit)}, 持有 ${o.dateIndex-e.dateIndex+1}天，盈利 ${(-100*t.profit/e.total).toFixed(2)}%\n       [买入 ${e.date}, ${c(e.price)}, ${e.count}, ${c(e.total)}] \n       [卖出 ${o.date}, ${c(o.price)}, ${o.count}, ${c(o.total)}, ${o.methodType}, ${o.memo}]`:`收入：---, 持有 ---天，盈利 ---\n       [买入 ${e.date}, ${c(e.price)}, ${e.count}, ${c(e.total)}]`}var $={executeTransaction:async function(t,e,o,a,n,i,s){let r=null;if(s.stoploss&&(r=s.stoploss.checkStoplossTransaction(i&&i.stock,e,o,a,s),d(e,n,r,i,s)&&u(`卖出止损：${e.format("YYYYMMDD")}，价格：${c(r.price)}元，数量：${r.count/100}手，总价：${r.total.toFixed(2)}元[佣金${r.commission.toFixed(2)}元，过户费${r.fee.toFixed(2)}，印花税${r.duty.toFixed(2)}元], ${r.memo}`)),r=t.checkSellTransaction(i&&i.stock,e,o,a,s),d(e,n,r,i,s)&&u(`卖出交易：${e.format("YYYYMMDD")}，价格：${r.price.toFixed(2)}元，数量：${r.count/100}手，总价：${r.total.toFixed(2)}元[佣金${r.commission.toFixed(2)}元，过户费${r.fee.toFixed(2)}，印花税${r.duty.toFixed(2)}元], ${r.memo}`),i&&i.stock&&i.stock.count>0)return;let l=i.balance;s.fixCash&&(l=s.initBalance),r=t.checkBuyTransaction(l,n,e,o,a,s),d(e,n,r,i,s)&&u(`买入交易：${e.format("YYYYMMDD")}，价格：${r.price.toFixed(2)}元，数量：${r.count/100}手，总价：${r.total.toFixed(2)}元[佣金${r.commission.toFixed(2)}元，过户费${r.fee.toFixed(2)}，印花税${r.duty.toFixed(2)}元], ${r.memo}`)},executeCapitalSettlement:d,createSellTransaction:function(t,e,o,a,n,i,s){let r=m(!1,t,a,n);return{date:e.format("YYYYMMDD"),dateIndex:o,type:"sell",count:a,price:n,total:r.total,amount:r.amount,fee:r.fee,commission:r.commission,duty:r.duty,methodType:i,memo:s}},createBuyTransaction:function(t,e,o,a,n,i,s){let r=100*parseInt(a/n/100);if(r<100)return;let l=m(!0,t,r,n);for(;l.total+a<0;){if(r-=100,r<100)return;l=m(!0,t,r,n)}return{date:e.format("YYYYMMDD"),dateIndex:o,type:"buy",count:r,price:n,total:l.total,amount:l.amount,fee:l.fee,commission:l.commission,duty:l.duty,methodType:i,memo:s}},calculateTransactionFee:m,parseCapital:f,logCapitalReport:function(t,e){t("******************************************************************************************"),e.stock&&e.stock.count>0?t(`  账户价值 ${c(e.balance+e.stock.count*e.stock.price)}元  【余额 ${c(e.balance)}元, 持股：${e.stock.info.name} ${c(e.stock.count*e.stock.price)}元】`):t(`  账户余额 ${c(e.balance)}元`);let o=f(e);t(`  总净利润：${c(o.total_profit)},  收益率 ${(100*o.ror).toFixed(2)}%`),t(`  毛利润： ${c(o.total_win)},  总亏损：${c(o.total_loss)}`),t(`  盈利收益率： ${(100*o.ror_win).toFixed(2)}%,  亏损收益率：${(100*o.ror_loss).toFixed(2)}%`),t(""),t(`  总交易次数： ${o.count},  利润率：${(100*o.count_win/o.count).toFixed(1)}%`),t(`  总盈利次数： ${o.count_win},  总亏损次数：${o.count_loss}`),t(""),t(`  最大单笔盈利： ${c(o.max_profit)},  最大单笔亏损：${c(o.max_loss)}`),t(`  平均盈利： ${c(o.average_win)},  平均亏损：${c(o.average_loss)}`),t(`  平均盈利/平均亏损： ${(o.average_win/o.average_loss).toFixed(2)},  平均每笔总盈利：${c(o.average_profit)}`),t(""),t(`  最多连续盈利次数： ${o.max_wintimes},  最多连续亏损次数：${o.max_losstimes}`),t(`  盈利最多持有天数： ${o.max_windays},  亏损最多持有天数：${o.max_lossdays}`),t(`  盈利平均持有天数： ${o.average_windays},  亏损平均持有天数：${o.average_lossdays}`),t("");for(let e in o.selltypes){let a=o.selltypes[e];t(`  卖出类型${e} 共${a.times}次,  盈利${a.win_times}次， 损失${a.loss_times}次`)}t("******************************************************************************************"),t("")},logTransactions:function(t,e){t("  交易日志分析\n******************************************************************************************");for(let o of e.transactions)t(p(o));if(e.stock&&e.stock.count>0){t(p({buy:e.stock.buy}))}t("******************************************************************************************")}};const y=l.default("mmb");function x(t,e,o,a,n,i){if(t<=0)return;let s=i&&i.N||1,r=i&&i.P||.5,l=0;for(let t=0;t<s;t++)if(a-t-1>=0){let e=n[a-t-1];"hl"===i.mmbType?l+=e.high-e.low:l+=e.high-e.close}l/=s;let c=n[a],u=c.open+l*r;return y(`买入条件检查${o.format("YYYYMMDD")}: ${u.toFixed(2)}=${c.open}+${l.toFixed(2)}*${r} [o: ${c.open}, h: ${c.high}, l: ${c.low}, c: ${c.close}, d: ${c.trade_date}]`),c.high>=u&&c.open<=u?(y("符合条件："+o.format("YYYYMMDD")),$.createBuyTransaction(e,o,a,t,u,"mmb",`动能突破买入 ${u.toFixed(2)} (=${c.open}+${l.toFixed(2)}*${(100*r).toFixed(2)}%)`)):void 0}let _={name:"MMB",description:"动能穿透",methodTyps:{mmb:"动能突破买入",mmb1:"开盘盈利卖出",mmb2:"动能突破卖出"},checkBuyTransaction:x,checkSellTransaction:function(t,e,o,a,n){if(r.default.isEmpty(t)||t.count<=0)return;if(!n.nommbsell&&!r.default.isEmpty(x(n.initBalance,t.info,e,o,a,n)))return;let i=a[o];if(!n.nommb1&&i.open>t.price)return y(`开盘盈利策略符合：${i.open.toFixed(2)} (> ${t.price.toFixed(2)})`),$.createSellTransaction(t.info,e,o,t.count,i.open,"mmb1",`开盘盈利卖出 ${i.open} (> ${t.price.toFixed(2)})`);if(!n.nommb2){let s=n&&n.N||1,r=n&&n.L||.5,l=0;for(let t=0;t<s;t++)if(o-t-1>=0){let e=a[o-t-1];"hl"===n.mmbType?l+=e.high-e.low:l+=e.high-e.close}l/=s;let c=i.open-l*r;if(c<=i.open&&c>=i.low)return $.createSellTransaction(t.info,e,o,t.count,c,"mmb2",`动能突破卖出：${c.toFixed(2)} (= ${i.open}-${l.toFixed(2)}*${100*r}%)`)}}};const b=console.log,h=l.default("sim");function F(t,e=2){t&&t.data&&t.data.length>0&&t.data.forEach(t=>{t.prevadj_factor&&(t.open=Number((t.open*t.prevadj_factor).toFixed(e)),t.close=Number((t.close*t.prevadj_factor).toFixed(e)),t.high=Number((t.high*t.prevadj_factor).toFixed(e)),t.low=Number((t.low*t.prevadj_factor).toFixed(e)),t.pre_close=Number((t.pre_close*t.prevadj_factor).toFixed(e)),t.change=Number((t.change*t.prevadj_factor).toFixed(e)))})}async function g(t,e){return t.data.reverse(),t}let Y={name:"SL",description:"止损",methodTypes:{stoploss:"止损卖出"},checkStoplossTransaction:function(t,e,o,a,n){if(r.default.isEmpty(t)||t.count<=0)return;let i=a[o],s=n&&n.S||.1,l=t.price*(1-s);return i.low<=l?$.createSellTransaction(t.info,e,o,t.count,l,"stoploss",`止损 ${l.toFixed(2)} (=${t.price.toFixed(2)}*(1-${100*s}%))`):void 0}};t.engine=$,t.formatFxstr=c,t.mmb=_,t.simulate=async function(t){let o=await e.readStockList();if(!o||!o.data)return void b("没有读取到股票列表，无法处理日线数据");let a=o.data;a=await async function(t,e){return e.selectedStocks.map(e=>t.filter(t=>t.ts_code===e)[0])}(a,t),b(`算法执行 ${a&&a.length} 条数据`),b("");for(let o of a){let a=await e.readStockData(e.stockDataNames.daily,o.ts_code),n={balance:t.initBalance,stock:{info:null,count:0,price:0},transactions:[]};if(a){b(`[${o.ts_code}]${o.name} 【数据更新时间：${s.default(a.updateTime).format("YYYY-MM-DD HH:mm")}】`),a=await g(a),F(a);let e=s.default("20190101","YYYYMMDD"),i=null;for(let l=0;l<a.data.length;l++){let c=a.data[l],u=s.default(c.trade_date,"YYYYMMDD");if(r.default.isEmpty(i)){if(e.isAfter(u))continue;h(`找到开始日期，开始执行算法！${l}, ${c.trade_date}`)}i=u;await $.executeTransaction(_,i,l,a.data,o,n,t)}$.logCapitalReport(b,n),t.showTrans&&$.logTransactions(b,n)}else b(`[${o.ts_code}]${o.name} 没有日线数据，请检查！`)}},t.stoploss=Y,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=lib-stock.js.map
